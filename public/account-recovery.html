<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account Recovery - VERA</title>
  <style>
    :root {
      --bg: #0f1221;
      --card: #171a2b;
      --text: #e8e7f0;
      --muted: #a9a6c3;
      --accent: #8c7ae6;
      --accent-2: #6c5ce7;
      --error: #ff6b6b;
      --success: #2ecc71;
      --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: radial-gradient(1200px 800px at 70% -10%, rgba(140,122,230,0.2), transparent), var(--bg); color: var(--text); }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 32px; }
    .card { width: 100%; max-width: 480px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: 16px; padding: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.35); }
    .title { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .orb { width: 36px; height: 36px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #c7b8ff, #6c5ce7); box-shadow: 0 0 30px rgba(140,122,230,0.5); animation: orbPulse 4s infinite ease-in-out; }
    @keyframes orbPulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    h1 { font-size: 1.25rem; margin: 0; font-weight: 600; letter-spacing: .02em; }
    p { color: var(--muted); margin: 0 0 18px 0; }
    label { display:block; font-size: .9rem; color: var(--muted); margin-bottom: 6px; }
    input { width: 100%; padding: 12px 14px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 10px; outline: none; transition: border .2s, box-shadow .2s; }
    input:focus { border-color: rgba(140,122,230,0.6); box-shadow: 0 0 0 4px rgba(140,122,230,0.15); }
    .actions { display:flex; gap: 12px; align-items:center; margin-top: 14px; }
    button { appearance: none; border: 0; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; padding: 12px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 10px 20px rgba(108,92,231,0.3); transition: all 0.3s ease; }
    button:hover { transform: translateY(-1px); box-shadow: 0 15px 25px rgba(108,92,231,0.4); }
    button:disabled { opacity: .6; cursor: not-allowed; transform: none; }
    .link { color: var(--muted); text-decoration: none; transition: color 0.2s ease; }
    .link:hover { color: var(--text); }
    .msg { margin-top: 12px; font-size: .95rem; }
    .msg.error { color: var(--error); }
    .msg.success { color: var(--success); }
    .hint { font-size: .85rem; color: var(--muted); margin-top: 8px; }
    .steps { margin-top: 20px; }
    .step { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 15px; }
    .step-num { width: 24px; height: 24px; border-radius: 12px; background: var(--accent); color: white; font-size: 12px; display: grid; place-items: center; flex-shrink: 0; }
    .step-content { flex: 1; }
    .step h3 { margin: 0 0 5px 0; font-size: 0.95rem; color: var(--text); }
    .step p { margin: 0; font-size: 0.9rem; }
    .loading { display: none; margin-left: 8px; }
    .loading.active { display: inline-block; animation: rotate 1s linear infinite; }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
  <meta name="robots" content="noindex" />
  <link rel="icon" href="/favicon.svg" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="Recover your VERA account securely." />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <div class="orb"></div>
        <h1>Account Recovery</h1>
      </div>
      <p>Enter your email address and we'll guide you through the recovery process.</p>
      <form id="recoveryForm" onsubmit="startRecovery(event)">
        <label for="email">Email</label>
        <input 
          id="email" 
          type="email" 
          placeholder="you@example.com" 
          autocomplete="email" 
          required 
        />
        <div class="actions">
          <button id="submitBtn" type="submit">
            Send Recovery Link
            <span id="loading" class="loading">â—Œ</span>
          </button>
          <a class="link" href="/login.html">Back to login</a>
        </div>
        <div id="msg" class="msg" role="status" aria-live="polite"></div>
      </form>
      
      <div class="steps">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-content">
            <h3>Enter Your Email</h3>
            <p>Provide the email address associated with your VERA account.</p>
          </div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-content">
            <h3>Check Your Inbox</h3>
            <p>Click the secure link we'll send to your email (valid for 15 minutes).</p>
          </div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-content">
            <h3>Return to VERA</h3>
            <p>You'll be automatically signed in and can continue your journey.</p>
          </div>
        </div>
      </div>
      <div class="hint">
        For security, recovery links expire after 15 minutes. Check your spam folder if you don't see our email.
      </div>
    </div>
  </div>
  
  <script>
    // Handle URL error parameters
    function checkUrlErrors() {
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');
      const msg = document.getElementById('msg');
      
      if (error) {
        msg.className = 'msg error';
        switch (error) {
          case 'invalid_token':
            msg.textContent = 'Invalid recovery link. Please request a new one.';
            break;
          case 'expired_token':
            msg.textContent = 'Recovery link has expired. Please request a new one.';
            break;
          case 'verification_failed':
            msg.textContent = 'Account recovery failed. Please try again.';
            break;
          case 'ip_blocked':
            msg.textContent = 'Access temporarily blocked due to too many attempts. Please try again tomorrow.';
            break;
          case 'too_many_attempts':
            msg.textContent = 'Too many recovery attempts. Please wait an hour and try again.';
            break;
        }
      }
    }
    
    window.addEventListener('load', checkUrlErrors);
    
    async function startRecovery(e) {
      e.preventDefault();
      const emailEl = document.getElementById('email');
      const btn = document.getElementById('submitBtn');
      const msg = document.getElementById('msg');
      const loading = document.getElementById('loading');
      const email = emailEl.value.trim();
      
      // Reset message state
      msg.textContent = '';
      msg.className = 'msg';
      
      if (!email || !email.includes('@')) {
        msg.textContent = 'Please enter a valid email address.';
        msg.classList.add('error');
        return;
      }
      
      // Show loading state
      btn.disabled = true;
      loading.classList.add('active');
      
      try {
        const res = await fetch('/api/auth/recover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          if (res.status === 429) {
            if (data.blocked) {
              throw new Error('Access temporarily blocked. Please try again tomorrow.');
            } else if (data.timeout) {
              throw new Error('Too many recovery attempts. Please wait an hour and try again.');
            }
          }
          throw new Error(data.error || 'Recovery failed. Please try again.');
        }
        
        // Success! Show confirmation message
        msg.textContent = data.message || 'Recovery link sent! Check your email and click the link within 15 minutes.';
        msg.classList.add('success');
        emailEl.value = ''; // Clear the form
        
        // Disable button for 5 minutes after successful request
        btn.disabled = true;
        setTimeout(() => { btn.disabled = false; }, 5 * 60 * 1000);
        
      } catch (err) {
        msg.textContent = err.message;
        msg.classList.add('error');
      } finally {
        loading.classList.remove('active');
      }
    }
  </script>
</body>
</html>